{% extends 'base.html' %} {% block title %}Profile - SpendSmart{% endblock %} {%
block content %}
<!-- Page Header -->
<div class="page-header">
  <h1>Profile</h1>
  <p>Manage your account settings</p>
</div>

<!-- Profile Grid -->
<div class="grid grid-2">
  <!-- User Info Card -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">User Info</h3>
    </div>
    <div style="text-align: center; padding: var(--space-4)">
      <div class="profile-avatar">{{ current_user.username[0].upper() }}</div>
      <h3 style="margin: var(--space-3) 0 var(--space-1) 0">
        {{ current_user.full_name or current_user.username }}
      </h3>
      <p class="text-muted" style="margin-bottom: var(--space-1)">
        @{{ current_user.username }}
      </p>
      <p class="text-muted" style="margin-bottom: var(--space-3)">
        {{ current_user.email }}
      </p>
      <p class="text-muted" style="font-size: 0.875rem">
        Member since {{ current_user.created_at.strftime('%B %Y') }}
      </p>
    </div>
  </div>

  <!-- Account Statistics -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Account Statistics</h3>
    </div>
    <div class="stats-grid" style="padding: var(--space-3)">
      <div class="stat-card">
        <span class="stat-label">Total Expenses</span>
        <div class="stat-value" id="totalExpensesCount">0</div>
      </div>
      <div class="stat-card">
        <span class="stat-label">Total Spent</span>
        <div class="stat-value" id="totalSpent">₹0</div>
      </div>
      <div class="stat-card">
        <span class="stat-label">Avg. Monthly</span>
        <div class="stat-value" id="avgMonthly">₹0</div>
      </div>
      <div class="stat-card">
        <span class="stat-label">Top Category</span>
        <div class="stat-value" id="topCategory" style="font-size: 1rem">-</div>
      </div>
    </div>
  </div>
</div>

<!-- Account Information -->
<div class="card">
  <div class="card-header">
    <h3 class="card-title">Account Information</h3>
  </div>

  <form
    method="POST"
    action="{{ url_for('main.profile') }}"
    class="grid grid-2"
    style="padding: var(--space-3)"
  >
    <div class="form-group">
      <label for="fullname" class="form-label">Full Name</label>
      <input
        type="text"
        class="form-control"
        id="fullname"
        name="fullname"
        value="{{ current_user.full_name or '' }}"
        placeholder="Enter full name"
      />
    </div>

    <div class="form-group">
      <label for="username" class="form-label">Username</label>
      <input
        type="text"
        class="form-control"
        id="username"
        name="username"
        value="{{ current_user.username }}"
        readonly
        disabled
      />
      <small class="text-muted">Username cannot be changed</small>
    </div>

    <div class="form-group" style="grid-column: span 2">
      <label for="email" class="form-label">Email Address</label>
      <input
        type="email"
        class="form-control"
        id="email"
        name="email"
        value="{{ current_user.email }}"
        required
      />
    </div>

    <div
      style="
        grid-column: span 2;
        height: 1px;
        background: var(--color-border);
        margin: var(--space-2) 0;
      "
    ></div>

    <div style="grid-column: span 2">
      <h4
        style="font-size: 1rem; font-weight: 600; margin-bottom: var(--space-3)"
      >
        Change Password
      </h4>
    </div>

    <div class="form-group" style="grid-column: span 2">
      <label for="current_password" class="form-label">Current Password</label>
      <input
        type="password"
        class="form-control"
        id="current_password"
        name="current_password"
        placeholder="Enter current password"
      />
      <small class="text-muted"
        >Leave blank if you don't want to change password</small
      >
    </div>

    <div class="form-group">
      <label for="new_password" class="form-label">New Password</label>
      <input
        type="password"
        class="form-control"
        id="new_password"
        name="new_password"
        placeholder="Enter new password"
        minlength="8"
      />
    </div>

    <div class="form-group">
      <label for="confirm_new_password" class="form-label"
        >Confirm New Password</label
      >
      <input
        type="password"
        class="form-control"
        id="confirm_new_password"
        name="confirm_new_password"
        placeholder="Confirm new password"
      />
    </div>

    <div
      style="
        grid-column: span 2;
        display: flex;
        gap: 1rem;
        margin-top: var(--space-2);
      "
    >
      <button type="submit" class="btn btn-primary">Save Changes</button>
      <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary"
        >Cancel</a
      >
    </div>
  </form>
</div>

<!-- Alert Container -->
<div
  id="alertContainer"
  style="position: fixed; top: 80px; right: 20px; z-index: 1000; width: 350px"
></div>
{% endblock %} {% block scripts %}
<script>
  // Show alerts
  function showAlert(message, type = 'info') {
      const alertContainer = document.getElementById('alertContainer');
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;
      alertContainer.appendChild(alertDiv);

      setTimeout(() => {
          alertDiv.style.opacity = '0';
          setTimeout(() => alertDiv.remove(), 300);
      }, 3000);
  }

  // Load user statistics
  async function loadUserStats() {
      try {
          const response = await fetch('/api/expenses');
          const result = await response.json();

          if (result.success) {
              const expenses = result.data;

              // Total expenses count
              document.getElementById('totalExpensesCount').textContent = expenses.length;

              // Total spent
              const totalSpent = expenses.reduce((sum, e) => sum + parseFloat(e.amount), 0);
              document.getElementById('totalSpent').textContent = `₹${totalSpent.toFixed(2)}`;

              // Average monthly (last 6 months)
              const sixMonthsAgo = new Date();
              sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
              const recentExpenses = expenses.filter(e => new Date(e.date) >= sixMonthsAgo);
              const avgMonthly = recentExpenses.length > 0
                  ? recentExpenses.reduce((sum, e) => sum + parseFloat(e.amount), 0) / 6
                  : 0;
              document.getElementById('avgMonthly').textContent = `₹${avgMonthly.toFixed(2)}`;

              // Top category
              const categories = {};
              expenses.forEach(e => {
                  categories[e.category] = (categories[e.category] || 0) + parseFloat(e.amount);
              });
              const topCat = Object.entries(categories).sort((a, b) => b[1] - a[1])[0];
              document.getElementById('topCategory').textContent = topCat ? topCat[0] : '-';
          }
      } catch (error) {
          console.error('Error loading stats:', error);
      }
  }

  // Form validation
  const profileForm = document.querySelector('form');
  if (profileForm) {
      profileForm.addEventListener('submit', function(e) {
          const currentPass = document.getElementById('current_password').value;
          const newPass = document.getElementById('new_password').value;
          const confirmPass = document.getElementById('confirm_new_password').value;

          if ((newPass || confirmPass) && !currentPass) {
              e.preventDefault();
              showAlert('Please enter your current password to change password', 'danger');
              return false;
          }

          if (newPass !== confirmPass) {
              e.preventDefault();
              showAlert('New passwords do not match!', 'danger');
              return false;
          }
      });
  }

  // Load stats on page load
  document.addEventListener('DOMContentLoaded', loadUserStats);

  // Show flask messages
  {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
          {% for category, message in messages %}
              showAlert('{{ message }}', '{{ category }}');
          {% endfor %}
      {% endif %}
  {% endwith %}
</script>
{% endblock %}
